<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MealsForAll</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"/>
  <style>
    /* General styles */
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
    body { background:#f8f9fa; }
    .app-container { max-width:1200px; margin:auto; padding:1rem; }
    .app-title { font-size:2rem; color:#4361ee; text-align:center; margin-bottom:1rem; }
    .main-layout { display:grid; gap:1rem; height:calc(100vh - 100px); }
    @media (min-width:768px) { .main-layout { grid-template-columns:280px 1fr; } }
    @media (max-width:767px) {
      .main-layout { display:block; }
      #map-container { display:none; }
      .main-layout.map-view #map-container { display:block; }
      .main-layout.map-view .sidebar { display:none; }
    }
    .sidebar, #map-container, #map { border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.05); }
    .sidebar { background:#fff; padding:1rem; display:flex; flex-direction:column; }
    #map-container, #map { height:100%; }
    .form-group { margin-bottom:1rem; }
    label { display:block; margin-bottom:.3rem; font-weight:500; }
    .input-with-icon { position:relative; }
    .input-with-icon i { position:absolute; left:.7rem; top:50%; transform:translateY(-50%); color:#adb5bd; }
    input { width:100%; padding:.7rem 1rem .7rem 2rem; border:1px solid #dee2e6; border-radius:8px; }
    input:focus { outline:none; border-color:#4361ee; }
    .button-group { display:flex; gap:.5rem; }
    .btn { padding:.7rem; border:none; border-radius:8px; font-weight:500; cursor:pointer; }
    .btn-primary { background:#4361ee; color:#fff; width:100%; }
    .btn-danger { background:#ef233c; color:#fff; }
    #cancel-btn { display:none; }
    .food-entries { margin-top:auto; max-height:250px; overflow-y:auto; }
    .entries-title { display:flex; justify-content:space-between; margin-bottom:.5rem; }
    .entries-counter { background:#4361ee; color:#fff; border-radius:10px; font-size:.75rem; padding:2px 6px; }
    .food-list { list-style:none; }
    .food-item { padding:.5rem; border-radius:6px; margin-bottom:.3rem; background:#f8f9fa; display:flex; justify-content:space-between; cursor:pointer; }
    .food-name { font-weight:600; }
    .food-location { font-size:.85rem; color:#6c757d; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .food-amount { background:#4361ee; color:#fff; border-radius:12px; font-size:.8rem; padding:2px 6px; margin-left:.5rem; }
    .loading-spinner { display:none; width:16px; height:16px; border:2px solid rgba(0,0,0,0.1); border-left-color:#4361ee; border-radius:50%; animation:spin 1s linear infinite; margin-left:8px; }
    @keyframes spin { to{transform:rotate(360deg);} }
    .custom-marker { display:flex; justify-content:center; align-items:center; font-size:28px; color:#fff; background:#4361ee; border-radius:50%; width:48px; height:48px; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
    .marker-temp { background:#ef233c; }
    .popup-content { padding:8px; max-width:250px; direction:rtl; text-align:right; }
    .popup-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .popup-header h4 { margin:0; font-size:1rem; }
    .popup-body p { margin:4px 0; }
    .popup-footer { text-align:right; margin-top:8px; }
    .close-popup { font-size:1.2rem; cursor:pointer; }
    .delete-btn { background:#ef233c; color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:.8rem; cursor:pointer; }
    .image-upload { display:flex; align-items:center; margin-bottom:1rem; }
    .image-preview { width:60px; height:60px; border-radius:8px; object-fit:cover; display:none; }
    .remove-image { position:absolute; top:0; right:0; background:rgba(0,0,0,0.6); color:#fff; padding:2px 6px; cursor:pointer; display:none; }
    .upload-btn { position:relative; overflow:hidden; background:#f8f9fa; color:#495057; padding:.5rem; border:none; border-radius:8px; cursor:pointer; }
    .upload-btn input { position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; }
    .food-image-thumbnail { width:50px; height:50px; border-radius:4px; margin-left:8px; object-fit:cover; }
    .popup-image { width:100%; max-height:150px; object-fit:cover; border-radius:6px; margin-top:8px; }
    .rating { display:flex; justify-content:center; margin-top:8px; }
    .rating .star { font-size:1.5rem; color:#ccc; cursor:pointer; margin:0 2px; }
    .rating .star.selected { color:#FFD700; }
    #toggle-map-btn { position:fixed; right:10px; bottom:10px; background:#4361ee; color:#fff; border:none; border-radius:50%; z-index:1000; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
    @media (max-width:767px){ #toggle-map-btn{width:50px;height:50px;} }
    @media (min-width:768px){ #toggle-map-btn{width:40px;height:40px;} }
    .empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:1rem; }
    .hamburger-btn { position:fixed; top:12px; right:8px; z-index:1100; background:transparent; border:none; font-size:32px; color:#4361ee; cursor:pointer; }
    .hamburger-popup { position:fixed; top:0; right:-320px; width:320px; height:100%; background:#fff; box-shadow:-4px 0 15px rgba(0,0,0,0.2); transition:right .3s ease; z-index:1050; padding:1.5rem; overflow-y:auto; }
    .hamburger-popup.open { right:0; }
    .popup-close-btn { position:absolute; top:10px; left:10px; background:transparent; border:none; font-size:28px; color:#4361ee; cursor:pointer; }
    .popup-nav { margin-top:50px; display:flex; justify-content:space-around; border-bottom:2px solid #eee; padding-bottom:.5rem; margin-bottom:1rem; }
    .nav-btn { background:none; border:none; font-size:1.1rem; color:#333; cursor:pointer; padding:.5rem 1rem; }
    .nav-btn.active { color:#4361ee; border-bottom:2px solid #4361ee; }
    .popup-page { display:none; }
    .popup-page.active { display:block; }
    .auth-links-popup { text-align:center; margin-top:1rem; border-top:1px solid #eee; padding-top:1rem; }
    .auth-links-popup a { margin:0 .5rem; text-decoration:underline; color:#4361ee; }
  </style>
</head>
<body>
  <!-- Hamburger -->
  <button id="hamburger-btn" class="hamburger-btn"><i class="fas fa-bars"></i></button>
  <div id="hamburger-popup" class="hamburger-popup">
    <button id="popup-close-btn" class="popup-close-btn"><i class="fas fa-times"></i></button>
    <div class="popup-nav">
      <button id="nav-map" class="nav-btn active">Map</button>
      <button id="nav-about" class="nav-btn">About</button>
    </div>
    <div id="popup-page-map" class="popup-page active">
      <a href="map.html" class="btn btn-primary" style="margin-bottom:1rem;">Open Full Map</a>
    </div>
    <div id="popup-page-about" class="popup-page">
      <a href="about.html" class="btn btn-primary" style="margin-bottom:1rem;">About</a>
    </div>
    <div class="auth-links-popup">
      <a href="login.html">Login</a> | <a href="register.html">Signup</a>
    </div>
  </div>

  <div class="app-container">
    <h1 class="app-title">MealsForAll</h1>
    <div style="text-align:center;margin-bottom:1rem;">
      <a href="login.html">login</a> | <a href="register.html">register</a>
    </div>
    <div class="main-layout">
      <div class="sidebar">
        <h2 style="margin-bottom:1rem;font-size:1.2rem;">הוסף מיקום מזון</h2>
        <div class="form-group">
          <label for="location">מיקום</label>
          <div class="input-with-icon">
            <i class="fas fa-map-marker-alt"></i>
            <input id="location" type="text" placeholder="הזן כתובת מלאה"/>
            <div id="loading-spinner" class="loading-spinner"></div>
          </div>
        </div>
        <div class="form-group">
          <label for="food">סוג מזון</label>
          <div class="input-with-icon">
            <i class="fas fa-utensils"></i>
            <input id="food" type="text" placeholder="איזה מזון זמין כאן?"/>
          </div>
        </div>
        <div class="form-group">
          <label for="phone">טלפון</label>
          <div class="input-with-icon">
            <i class="fas fa-phone"></i>
            <input id="phone" type="text" placeholder="הזן מספר טלפון"/>
          </div>
        </div>
        <div class="form-group">
          <label for="amount">כמות</label>
          <div class="input-with-icon">
            <i class="fas fa-hashtag"></i>
            <input id="amount" type="number" min="1" value="1"/>
          </div>
        </div>
        <div class="form-group image-upload">
          <button class="upload-btn">
            <i class="fas fa-camera"></i> העלה תמונה
            <input id="food-image" type="file" accept="image/*"/>
          </button>
          <div style="position:relative;">
            <img id="image-preview" class="image-preview" alt="Preview"/>
            <span id="remove-image" class="remove-image">&times;</span>
          </div>
        </div>
        <div class="button-group">
          <button id="submit-btn" class="btn btn-primary"><i class="fas fa-plus"></i> הוסף</button>
          <button id="cancel-btn" class="btn btn-danger"><i class="fas fa-times"></i> ביטול</button>
        </div>
        <div class="food-entries">
          <div class="entries-title">
            <h2 style="font-size:1.1rem;">מיקומי מזון זמינים</h2>
            <span id="entries-count" class="entries-counter">0</span>
          </div>
          <div id="empty-state" class="empty-state">
            <i class="fas fa-map" style="font-size:2rem; margin-bottom:.5rem;"></i>
            <p>אין מיקומים זמינים</p>
          </div>
          <ul id="food-list" class="food-list"></ul>
        </div>
      </div>
      <div id="map-container"><div id="map"></div></div>
    </div>
  </div>
  <button id="toggle-map-btn"><i class="fas fa-arrow-right"></i></button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPA_URL = 'https://dieltjdqgeppyixximwe.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpZWx0amRxZ2VwcHlpeHhpbXdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEwMzY2MzMsImV4cCI6MjA1NjYxMjYzM30.NXZfUyvyrPzAeT75vWWWjY5h1LOe_vwaFiHBS1TMwtw';
    const sb = supabase.createClient(SUPA_URL, SUPA_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true
      }
    });

    let currentUserId = null,
        map, markers = {}, foodLocations = [], selectedCoordinates = null, selectedImage = null;

    const els = {
      location: document.getElementById('location'),
      food:     document.getElementById('food'),
      phone:    document.getElementById('phone'),
      amount:   document.getElementById('amount'),
      loading:  document.getElementById('loading-spinner'),
      submit:   document.getElementById('submit-btn'),
      cancel:   document.getElementById('cancel-btn'),
      foodImage:document.getElementById('food-image'),
      preview:  document.getElementById('image-preview'),
      removeImg:document.getElementById('remove-image'),
      list:     document.getElementById('food-list'),
      count:    document.getElementById('entries-count'),
      empty:    document.getElementById('empty-state'),
      toggle:   document.getElementById('toggle-map-btn'),
      hbBtn:    document.getElementById('hamburger-btn'),
      hbPopup:  document.getElementById('hamburger-popup'),
      popClose: document.getElementById('popup-close-btn'),
      navMap:   document.getElementById('nav-map'),
      navAbout: document.getElementById('nav-about'),
      pageMap:  document.getElementById('popup-page-map'),
      pageAbout:document.getElementById('popup-page-about')
    };

    const formatTime = ms => {
      const h = Math.floor(ms/3600000),
            m = Math.floor((ms%3600000)/60000);
      return `${h}h ${m}m`;
    };

    const createIcon = isTemp => L.divIcon({
      className: 'custom-marker'+(isTemp?' marker-temp':''),
      html: `<i class="fas fa-${isTemp?'crosshairs':'utensils'}"></i>`,
      iconSize:[48,48], iconAnchor:[24,24]
    });

    function renderList(){
      els.list.innerHTML = '';
      els.count.textContent = foodLocations.length;
      els.empty.style.display = foodLocations.length?'none':'flex';
      foodLocations.sort((a,b)=>b.timestamp-a.timestamp).forEach(e=>{
        const li = document.createElement('li');
        li.className='food-item';
        li.innerHTML=`
          <div>
            <div class="food-name">${e.food}</div>
            <div class="food-location">${e.location}</div>
            <div class="expiry-info">נגמר בעוד: ${formatTime(e.expiresAt-Date.now())}</div>
          </div>
          <div style="display:flex;align-items:center;">
            <span class="food-amount">${e.amount}</span>
            ${e.imageUrl?`<img src="${e.imageUrl}" class="food-image-thumbnail">`:''}
          </div>`;
        li.onclick=()=>{
          map.setView([e.coordinates.lat,e.coordinates.lng],15);
          markers[e.id]?.openPopup();
        };
        els.list.appendChild(li);
      });
    }

    function addMarker(e,isTemp=false){
      if(!isTemp && markers[e.id]) map.removeLayer(markers[e.id]);
      const m = L.marker([e.coordinates.lat,e.coordinates.lng],{icon:createIcon(isTemp)}).addTo(map);
      const canDelete = !isTemp && e.createdBy===currentUserId;
      let html=`
        <div class="popup-content">
          <div class="popup-header">
            <span class="close-popup">&times;</span>
            <h4>${e.food}</h4>
          </div>
          <div class="popup-body">
            <p>${e.location}</p>
            <p>כמות: ${e.amount}</p>
            <p style="font-size:.8rem;color:#6c757d;">
              נגמר בעוד: ${formatTime(e.expiresAt-Date.now())}
            </p>
            ${e.imageUrl?`<img src="${e.imageUrl}" class="popup-image">`:''}
          </div>
          <div class="popup-footer">
            ${canDelete?`<button class="delete-btn"><i class="fas fa-trash"></i> Delete</button>`:``}
          </div>
        </div>`;
      m.bindPopup(html);
      m.getPopup().on('add',()=>{
        const c = m.getPopup()._container;
        c.querySelector('.close-popup').onclick = ()=>m.closePopup();
        if(canDelete){
          c.querySelector('.delete-btn').onclick = async()=>{
            if(!confirm('Delete this location?')) return;
            await sb.from('food_locations').delete().eq('id',e.id);
            m.closePopup();
            map.removeLayer(m); delete markers[e.id];
            foodLocations = foodLocations.filter(f=>f.id!==e.id);
            renderList();
          };
        }
      });
      if(isTemp){
        markers.temp=m; m.isTemporary=true;
      } else {
        markers[e.id]=m;
      }
    }

    async function loadInitial(){
      let now=Date.now();
      const { data, error } = await sb.from('food_locations').select('*').gt('expiresAt',now);
      if(error){ console.error(error); return; }
      foodLocations=data;
      foodLocations.forEach(e=>addMarker(e));
      renderList();
    }

    function setupRealtime(){
      sb.channel('public:food_locations')
        .on('postgres_changes',{event:'INSERT',schema:'public',table:'food_locations'},payload=>{
          if(payload.new.expiresAt>Date.now()){
            foodLocations.push(payload.new);
            addMarker(payload.new);
            renderList();
          }
        })
        .on('postgres_changes',{event:'UPDATE',schema:'public',table:'food_locations'},payload=>{
          if(payload.new.expiresAt>Date.now()){
            foodLocations=foodLocations.map(f=>f.id===payload.new.id?payload.new:f);
            addMarker(payload.new);
          } else {
            foodLocations=foodLocations.filter(f=>f.id!==payload.new.id);
            map.removeLayer(markers[payload.new.id]); delete markers[payload.new.id];
          }
          renderList();
        })
        .on('postgres_changes',{event:'DELETE',schema:'public',table:'food_locations'},payload=>{
          foodLocations=foodLocations.filter(f=>f.id!==payload.old.id);
          map.removeLayer(markers[payload.old.id]); delete markers[payload.old.id];
          renderList();
        })
        .subscribe();
    }

    async function reverseGeocode(lat,lng){
      els.loading.style.display='inline-block';
      try{
        let r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        let j=await r.json();
        els.location.value=j.display_name||`${lat.toFixed(5)},${lng.toFixed(5)}`;
      }catch{
        els.location.value=`${lat.toFixed(5)},${lng.toFixed(5)}`;
      }
      els.loading.style.display='none';
    }

    async function uploadImage(file,id){
      if(!file||!file.type.startsWith("image/")){alert('Not an image');return null;}
      const ext=file.name.split('.').pop();
      const name=`${id}_${Date.now()}_${Math.random().toString(36).substr(2,5)}.${ext}`;
      let { error } = await sb.storage.from('food_images').upload(name,file,{cacheControl:'3600',upsert:false});
      if(error){console.error(error);alert('Upload failed');return null;}
      let { data:pub } = sb.storage.from('food_images').getPublicUrl(name);
      return pub.publicUrl;
    }

    window.onload = async()=>{
      // session
      let { data:{session} } = await sb.auth.getSession();
      currentUserId = session?.user?.id||null;

      // map init
      map = L.map('map',{center:[31.7683,35.2137],zoom:8});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      // map click => select
      map.on('click', e=>{
        if(markers.temp){ map.removeLayer(markers.temp); delete markers.temp; }
        const {lat,lng}=e.latlng;
        selectedCoordinates=[lat,lng];
        reverseGeocode(lat,lng);
        const popup = L.DomUtil.create('div','popup-content');
        popup.innerHTML=`
          <div class="popup-header">
            <span class="close-popup">&times;</span>
            <h4>מיקום נבחר</h4>
          </div>
          <div class="popup-body"><p>${lat.toFixed(5)}, ${lng.toFixed(5)}</p></div>`;
        const m=L.marker([lat,lng],{icon:createIcon(true)}).addTo(map).bindPopup(popup).openPopup();
        m.isTemporary=true; markers.temp=m;
        popup.querySelector('.close-popup').onclick=()=>m.closePopup();
        els.cancel.style.display='block';
      });

      // load & realtime
      await loadInitial();
      setupRealtime();

      // periodic expire
      setInterval(()=>{
        const now=Date.now();
        foodLocations.filter(f=>f.expiresAt<=now).forEach(f=>sb.from('food_locations').delete().eq('id',f.id));
      },60000);

      // image preview
      els.foodImage.onchange=function(){
        if(this.files[0]){
          selectedImage=this.files[0];
          const r=new FileReader();
          r.onload=e=>{
            els.preview.src=e.target.result;
            els.preview.style.display='block';
            els.removeImg.style.display='block';
          };
          r.readAsDataURL(selectedImage);
        }
      };
      els.removeImg.onclick=()=>{
        els.preview.style.display='none';
        els.preview.src='';
        els.removeImg.style.display='none';
        selectedImage=null;
      };

      // publish
      els.submit.onclick = ()=>{
        if(!currentUserId){
          alert('Login required');
          return window.location.href='login.html';
        }
        const loc=els.location.value.trim(),
              food=els.food.value.trim(),
              phone=els.phone.value.trim(),
              amt=els.amount.value.trim();
        if(!loc||!food||!phone||!amt){
          return alert('Fill all fields');
        }
        if(!selectedCoordinates){
          return alert('Select on map or type address');
        }
        (async()=>{
          const now=Date.now();
          let imageUrl=null;
          if(selectedImage) imageUrl=await uploadImage(selectedImage,now.toString());
          const entry={
            location:loc,food,phone,
            amount:parseInt(amt),
            coordinates:{lat:selectedCoordinates[0],lng:selectedCoordinates[1]},
            timestamp:now,
            expiresAt:now+24*3600000,
            imageUrl,
            createdBy:currentUserId
          };
          let { error }=await sb.from('food_locations').insert([entry]);
          if(error){console.error(error);return alert('Insert failed');}
          // reset
          els.location.value='';els.food.value='';els.phone.value='';els.amount.value='1';
          els.preview.style.display='none';els.preview.src='';els.removeImg.style.display='none';
          if(markers.temp){ map.removeLayer(markers.temp); delete markers.temp; }
          els.cancel.style.display='none';
        })();
      };

      // cancel
      els.cancel.onclick=()=>{
        if(markers.temp){ map.removeLayer(markers.temp); delete markers.temp; }
        selectedCoordinates=null;
        els.location.value='';
        els.cancel.style.display='none';
      };

      // toggle
      els.toggle.onclick=()=>{
        const ml=document.querySelector('.main-layout');
        if(window.innerWidth>=768){
          ml.classList.toggle('collapse-sidebar');
        } else {
          ml.classList.toggle('map-view');
          setTimeout(()=>map.invalidateSize(),100);
        }
        els.toggle.innerHTML = ml.classList.contains('collapse-sidebar')||ml.classList.contains('map-view')
          ? '<i class="fas fa-arrow-left"></i>'
          : '<i class="fas fa-arrow-right"></i>';
      };

      // hamburger
      els.hbBtn.onclick  = ()=>els.hbPopup.classList.add('open');
      els.popClose.onclick = ()=>els.hbPopup.classList.remove('open');
      els.navMap.onclick = ()=>{
        els.navMap.classList.add('active');
        els.navAbout.classList.remove('active');
        els.pageMap.classList.add('active');
        els.pageAbout.classList.remove('active');
      };
      els.navAbout.onclick = ()=>{
        els.navAbout.classList.add('active');
        els.navMap.classList.remove('active');
        els.pageAbout.classList.add('active');
        els.pageMap.classList.remove('active');
      };
    };
  </script>
</body>
</html>

