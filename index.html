<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MealsForAll</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; }
    body { background:#f8f9fa; }
    .app-container { max-width:1200px; margin:auto; padding:1rem; }
    .app-title { font-size:2rem; color:#4361ee; margin-bottom:1rem; text-align:center; }
    .main-layout { display:grid; gap:1rem; height:calc(100vh - 100px); }
    @media (min-width:768px) { .main-layout { grid-template-columns:280px 1fr; } }
    @media (max-width:767px) {
      .main-layout { display:block; }
      .sidebar { display:block; }
      #map-container { display:none; }
      .main-layout.map-view #map-container { display:block; }
      .main-layout.map-view .sidebar { display:none; }
    }
    .sidebar, #map-container, #map { border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.05); }
    .sidebar { background:#fff; padding:1rem; display:flex; flex-direction:column; }
    #map-container, #map { height:100%; overflow:hidden; }
    .form-group { margin-bottom:1rem; }
    label { display:block; margin-bottom:.3rem; font-weight:500; }
    .input-with-icon { position:relative; }
    .input-with-icon i { position:absolute; left:.7rem; top:50%; transform:translateY(-50%); color:#adb5bd; }
    input { width:100%; padding:.7rem 1rem .7rem 2rem; border:1px solid #dee2e6; border-radius:8px; }
    input:focus { outline:none; border-color:#4361ee; }
    .btn { padding:.7rem; border:none; border-radius:8px; font-weight:500; cursor:pointer; }
    .btn-primary { background:#4361ee; color:#fff; width:100%; }
    .btn-danger { background:#ef233c; color:#fff; }
    .button-group { display:flex; gap:.5rem; }
    #cancel-btn { display:none; }
    .food-entries { margin-top:auto; max-height:250px; overflow-y:auto; }
    .entries-title { display:flex; justify-content:space-between; margin-bottom:.5rem; }
    .entries-counter { background:#4361ee; color:#fff; border-radius:10px; font-size:.75rem; padding:2px 6px; }
    .food-list { list-style:none; }
    .food-item { padding:.5rem; border-radius:6px; margin-bottom:.3rem; background:#f8f9fa; display:flex; justify-content:space-between; cursor:pointer; }
    .food-name { font-weight:600; }
    .food-location { font-size:.85rem; color:#6c757d; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .food-amount { background:#4361ee; color:#fff; border-radius:12px; font-size:.8rem; padding:2px 6px; margin-left:.5rem; }
    .loading-spinner { display:none; width:16px; height:16px; border:2px solid rgba(0,0,0,0.1); border-left-color:#4361ee; border-radius:50%; animation:spin 1s linear infinite; margin-left:8px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .custom-marker { display:flex; justify-content:center; align-items:center; font-size:28px; color:#fff; background:#4361ee; border-radius:50%; width:48px; height:48px; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
    .popup-content { padding:8px; direction:rtl; text-align:right; max-width:250px; }
    .popup-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .popup-header h4 { margin:0; font-size:1rem; }
    .popup-body p { margin:4px 0; }
    .popup-footer { text-align:right; margin-top:8px; }
    .close-popup { font-size:1.2rem; cursor:pointer; }
    .delete-btn { background:#ef233c; color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:.8rem; cursor:pointer; }
    .image-upload { display:flex; align-items:center; margin-bottom:1rem; }
    .image-preview { width:60px; height:60px; border-radius:8px; object-fit:cover; display:none; }
    .remove-image { position:absolute; top:0; right:0; background:rgba(0,0,0,0.6); color:#fff; padding:2px 6px; font-size:1rem; cursor:pointer; display:none; }
    .upload-btn { position:relative; overflow:hidden; background:#f8f9fa; color:#495057; padding:.5rem; border:none; border-radius:8px; cursor:pointer; }
    .upload-btn input[type=file] { position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer; }
    .food-image-thumbnail { width:50px; height:50px; border-radius:4px; margin-left:8px; object-fit:cover; }
    .popup-image { width:100%; max-height:150px; object-fit:cover; border-radius:6px; margin-top:8px; }
    #toggle-map-btn { position:fixed; right:10px; bottom:10px; background:#4361ee; color:#fff; border:none; border-radius:50%; z-index:1000; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
    @media (max-width:767px) { #toggle-map-btn { width:50px; height:50px; } }
    @media (min-width:768px) { #toggle-map-btn { width:40px; height:40px; } }
    .empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:1rem; }
  </style>
</head>
<body>
  <div class="app-container">
    <h1 class="app-title">MealsForAll</h1>
    <div style="text-align:center; margin-bottom:1rem;">
      <a href="login.html">login</a> | <a href="register.html">register</a>
    </div>
    <div class="main-layout">
      <div class="sidebar">
        <h2 style="margin-bottom:1rem; font-size:1.2rem;">הוסף מיקום מזון</h2>
        <div class="form-group">
          <label for="location">מיקום</label>
          <div class="input-with-icon">
            <i class="fas fa-map-marker-alt"></i>
            <input type="text" id="location" placeholder="הזן כתובת מלאה" />
            <div id="loading-spinner" class="loading-spinner"></div>
          </div>
        </div>
        <div class="form-group">
          <label for="food">סוג מזון</label>
          <div class="input-with-icon">
            <i class="fas fa-utensils"></i>
            <input type="text" id="food" placeholder="איזה מזון זמין כאן?" />
          </div>
        </div>
        <div class="form-group">
          <label for="phone">טלפון</label>
          <div class="input-with-icon">
            <i class="fas fa-phone"></i>
            <input type="text" id="phone" placeholder="הזן מספר טלפון" />
          </div>
        </div>
        <div class="form-group">
          <label for="amount">כמות</label>
          <div class="input-with-icon">
            <i class="fas fa-hashtag"></i>
            <input type="number" id="amount" min="1" value="1" />
          </div>
        </div>
        <div class="form-group image-upload">
          <button class="upload-btn">
            <i class="fas fa-camera"></i> העלה תמונה
            <input type="file" id="food-image" accept="image/*" />
          </button>
          <div style="position:relative;">
            <img id="image-preview" class="image-preview" alt="תצוגה מקדימה" />
            <span id="remove-image" class="remove-image">&times;</span>
          </div>
        </div>
        <div class="button-group">
          <button id="submit-btn" class="btn btn-primary"><i class="fas fa-plus"></i> הוסף</button>
          <button id="cancel-btn" class="btn btn-danger"><i class="fas fa-times"></i> ביטול</button>
        </div>
        <div class="food-entries">
          <div class="entries-title">
            <h2 style="font-size:1.1rem;">מיקומי מזון זמינים</h2>
            <span id="entries-count" class="entries-counter">0</span>
          </div>
          <div id="empty-state" class="empty-state"><i class="fas fa-map" style="font-size:2rem;margin-bottom:.5rem;"></i><p>אין מיקומים זמינים</p></div>
          <ul id="food-list" class="food-list"></ul>
        </div>
      </div>
      <div id="map-container"><div id="map"></div></div>
    </div>
  </div>
  <button id="toggle-map-btn"><i class="fas fa-arrow-right"></i></button>

  <script>
    const SUPA_URL = 'https://dieltjdqgeppyixximwe.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9…';
    const sb = supabase.createClient(SUPA_URL, SUPA_KEY);

    let currentUserId = null;
    let map, markers = {}, foodLocations = [];
    const els = {
      location: document.getElementById('location'),
      food: document.getElementById('food'),
      phone: document.getElementById('phone'),
      amount: document.getElementById('amount'),
      foodImage: document.getElementById('food-image'),
      imagePreview: document.getElementById('image-preview'),
      removeImage: document.getElementById('remove-image'),
      submitBtn: document.getElementById('submit-btn'),
      cancelBtn: document.getElementById('cancel-btn'),
      loadingSpinner: document.getElementById('loading-spinner'),
      foodList: document.getElementById('food-list'),
      entriesCount: document.getElementById('entries-count'),
      emptyState: document.getElementById('empty-state'),
      toggleBtn: document.getElementById('toggle-map-btn')
    };

    const formatTime = ms => {
      const h = Math.floor(ms/3600000);
      const m = Math.floor((ms%3600000)/60000);
      return `${h}h ${m}m`;
    };

    const createMarkerIcon = () => L.divIcon({
      className:'custom-marker',
      html:'<i class="fas fa-utensils"></i>',
      iconSize:[48,48],
      iconAnchor:[24,24]
    });

    function renderList() {
      els.foodList.innerHTML = '';
      els.entriesCount.textContent = foodLocations.length;
      els.emptyState.style.display = foodLocations.length ? 'none' : 'flex';
      foodLocations
        .sort((a,b)=>b.timestamp-a.timestamp)
        .forEach(e=>{
          const li = document.createElement('li');
          li.className='food-item';
          li.innerHTML=`
            <div>
              <div class="food-name">${e.food}</div>
              <div class="food-location">${e.location}</div>
              <div class="expiry-info">נגמר בעוד: ${formatTime(e.expiresAt-Date.now())}</div>
            </div>
            <div style="display:flex;align-items:center;">
              <span class="food-amount">${e.amount}</span>
              ${e.imageUrl?`<img src="${e.imageUrl}" class="food-image-thumbnail">`:''}
            </div>`;
          li.addEventListener('click',()=>{
            map.setView([e.coordinates.lat,e.coordinates.lng],15);
            markers[e.id]?.openPopup();
          });
          els.foodList.appendChild(li);
        });
    }

    function addMapMarker(e){
      if(markers[e.id]) map.removeLayer(markers[e.id]);
      const m=L.marker([e.coordinates.lat,e.coordinates.lng],{icon:createMarkerIcon()}).addTo(map);
      m.bindPopup(`
        <div class="popup-content">
          <div class="popup-header"><span class="close-popup">&times;</span><h4>${e.food}</h4></div>
          <div class="popup-body">
            <p>${e.location}</p>
            <p>כמות: ${e.amount}</p>
            <p style="font-size:.8rem;color:#6c757d;">נגמר בעוד: ${formatTime(e.expiresAt-Date.now())}</p>
            ${e.imageUrl?`<img src="${e.imageUrl}" class="popup-image">`:''}
          </div>
        </div>
      `);
      m.getPopup().on('add',()=>{
        m.getPopup()._container.querySelector('.close-popup').onclick=()=>m.closePopup();
      });
      markers[e.id]=m;
    }

    async function loadInitial(){
      const now=Date.now();
      const {data,error}=await sb.from('food_locations').select('*').gt('expiresAt',now);
      if(error)return console.error(error);
      foodLocations=data;
      foodLocations.forEach(addMapMarker);
      renderList();
    }

    function handleInsert({new:newE}){
      if(newE.expiresAt<=Date.now())return;
      foodLocations.push(newE);
      addMapMarker(newE);
      renderList();
    }
    function handleUpdate({new:upd}){
      if(upd.expiresAt<=Date.now()){
        foodLocations=foodLocations.filter(x=>x.id!==upd.id);
        map.removeLayer(markers[upd.id]); delete markers[upd.id];
      } else {
        foodLocations=foodLocations.map(x=>x.id===upd.id?upd:x);
        addMapMarker(upd);
      }
      renderList();
    }
    function handleDelete({old:oldE}){
      foodLocations=foodLocations.filter(x=>x.id!==oldE.id);
      map.removeLayer(markers[oldE.id]); delete markers[oldE.id];
      renderList();
    }

    window.onload=async()=>{
      const {data:{session}}=await sb.auth.getSession();
      currentUserId=session?.user?.id||null;

      map=L.map('map',{center:[31.7683,35.2137],zoom:8});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      await loadInitial();

      sb.channel('public:food_locations')
        .on('postgres_changes',{event:'INSERT',schema:'public',table:'food_locations'},handleInsert)
        .on('postgres_changes',{event:'UPDATE',schema:'public',table:'food_locations'},handleUpdate)
        .on('postgres_changes',{event:'DELETE',schema:'public',table:'food_locations'},handleDelete)
        .subscribe();

      setInterval(()=>{
        const now=Date.now();
        foodLocations.filter(e=>e.expiresAt<=now).forEach(e=>handleDelete({old:e}));
      },60000);

      els.toggleBtn.addEventListener('click',()=>{
        const ml=document.querySelector('.main-layout');
        if(window.innerWidth>=768){
          ml.classList.toggle('collapse-sidebar');
          els.toggleBtn.innerHTML=ml.classList.contains('collapse-sidebar')?'<i class="fas fa-arrow-left"></i>':'<i class="fas fa-arrow-right"></i>';
        } else {
          ml.classList.toggle('map-view');
          els.toggleBtn.innerHTML=ml.classList.contains('map-view')?'<i class="fas fa-arrow-left"></i>':'<i class="fas fa-arrow-right"></i>';
          setTimeout(()=>map.invalidateSize(),100);
        }
      });
    };
  </script>
</body>
</html>
